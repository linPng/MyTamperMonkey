// ==UserScript==
// @name         GYING.NET M3U8 Video Downloader
// @namespace    http://tampermonkey.net/
// @version      3.0
// @description  M3U8 video downloader specifically for gying.net with collapsible interface
// @author       You
// @match        *://www.gying.net/*
// @match        *://gying.net/*
// @grant        none
// ==/UserScript==

(function() {
    'use strict';

    const SERVICE_URL = 'http://localhost:8899';
    let detectedVideos = new Map();
    let detectedM3U8s = new Map();
    let isServiceAvailable = false;
    let videoCounter = 0;
    let m3u8Counter = 0;
    let isPanelVisible = false;

    // æ£€æŸ¥æœåŠ¡å¯ç”¨æ€§
    async function checkServiceAvailability() {
        try {
            const response = await fetch(`${SERVICE_URL}/health`);
            const data = await response.json();
            isServiceAvailable = data.status === 'ok';
            console.log('ğŸ“¡ æœåŠ¡çŠ¶æ€:', data);
            return isServiceAvailable;
        } catch (error) {
            isServiceAvailable = false;
            console.error('âŒ æœåŠ¡ä¸å¯ç”¨:', error);
            return false;
        }
    }

    // æ™ºèƒ½æå–è§†é¢‘æ ‡é¢˜
    function extractVideoTitle() {
        const titleSelectors = [
            'h1',
            '.title',
            '[class*="title"]',
            'meta[property="og:title"]',
            'meta[name="title"]'
        ];

        for (const selector of titleSelectors) {
            try {
                const element = document.querySelector(selector);
                if (element) {
                    let title = element.textContent || element.getAttribute('content');
                    if (title && title.trim()) {
                        title = cleanTitle(title.trim());
                        if (title && title.length > 3) {
                            console.log(`ğŸ¯ ä»é€‰æ‹©å™¨ ${selector} æå–åˆ°æ ‡é¢˜: ${title}`);
                            return title;
                        }
                    }
                }
            } catch (e) {
                // ç»§ç»­å°è¯•ä¸‹ä¸€ä¸ªé€‰æ‹©å™¨
            }
        }

        // ä»URLè·¯å¾„æå–
        const pathMatch = window.location.pathname.match(/\/([^\/]+)\/(\d+)/);
        if (pathMatch) {
            return `${pathMatch[1]} ç¬¬${pathMatch[2]}é›†`;
        }

        // æœ€åçš„å¤‡é€‰æ–¹æ¡ˆ
        const pageTitle = document.title;
        if (pageTitle && pageTitle.trim()) {
            const cleanedTitle = cleanTitle(pageTitle);
            if (cleanedTitle && cleanedTitle.length > 3) {
                return cleanedTitle;
            }
        }

        return `GYINGè§†é¢‘_${new Date().toISOString().slice(0, 16).replace(/[-:]/g, '')}`;
    }

    // æ¸…ç†æ ‡é¢˜æ–‡æœ¬
    function cleanTitle(title) {
        if (!title) return '';

        // ç§»é™¤HTMLæ ‡ç­¾
        title = title.replace(/<[^>]*>/g, '');

        // ç§»é™¤å¸¸è§çš„æ— ç”¨æ–‡æœ¬
        const removePatterns = [
            /æ’­æ”¾é€Ÿåº¦.*/,
            /ç”»é¢æ¯”ä¾‹.*/,
            /Player version.*/,
            /Video url.*/,
            /Video time.*/,
            /Video duration.*/,
            /blob:https?.*/,
            /\d{4,}:\d{2}/g,
            /\[x\]/g,
            /é€‰é›†.*$/,
            /æ­£å¸¸.*$/,
            /åœ¨çº¿è§‚çœ‹.*/,
            /-.*å½±è§†$/
        ];

        for (const pattern of removePatterns) {
            title = title.replace(pattern, '');
        }

        // æ¸…ç†å¤šä½™çš„ç©ºç™½å­—ç¬¦
        title = title.replace(/\s+/g, ' ').trim();

        // å¦‚æœæ ‡é¢˜å¤ªé•¿ï¼Œå–å‰é¢éƒ¨åˆ†
        if (title.length > 50) {
            const breakPoints = [' - ', ' | ', ' ç¬¬', 'ç¬¬'];
            for (const bp of breakPoints) {
                const index = title.indexOf(bp);
                if (index > 10 && index < 50) {
                    title = title.substring(0, index);
                    break;
                }
            }

            if (title.length > 50) {
                title = title.substring(0, 50);
            }
        }

        return title.trim();
    }

    // æ£€æŸ¥æ˜¯å¦ä¸ºM3U8 URL
    function isM3U8Url(url) {
        return url && (
            url.toLowerCase().includes('.m3u8') ||
            url.toLowerCase().includes('manifest') ||
            url.toLowerCase().includes('playlist.m3u8') ||
            url.toLowerCase().includes('index.m3u8')
        );
    }

    // åˆ›å»ºæ‚¬æµ®æŒ‰é’®
    function createFloatingButton() {
        const button = document.createElement('div');
        button.id = 'video-downloader-btn';
        button.innerHTML = 'ğŸ¬';
        button.title = 'M3U8è§†é¢‘ä¸‹è½½å™¨';
        button.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 20px;
            cursor: pointer;
            z-index: 10001;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            user-select: none;
        `;

        // æ·»åŠ çŠ¶æ€æŒ‡ç¤ºå™¨
        const indicator = document.createElement('div');
        indicator.id = 'service-indicator';
        indicator.style.cssText = `
            position: absolute;
            top: -2px;
            right: -2px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: ${isServiceAvailable ? '#10b981' : '#ef4444'};
            border: 2px solid white;
            animation: ${isServiceAvailable ? 'none' : 'pulse 2s infinite'};
        `;

        button.appendChild(indicator);

        // æ·»åŠ æ‚¬åœæ•ˆæœ
        button.addEventListener('mouseenter', () => {
            button.style.transform = 'scale(1.1)';
            button.style.boxShadow = '0 6px 20px rgba(0,0,0,0.4)';
        });

        button.addEventListener('mouseleave', () => {
            button.style.transform = 'scale(1)';
            button.style.boxShadow = '0 4px 15px rgba(0,0,0,0.3)';
        });

        // ç‚¹å‡»äº‹ä»¶
        button.addEventListener('click', togglePanel);

        document.body.appendChild(button);

        // æ·»åŠ CSSåŠ¨ç”»
        if (!document.getElementById('downloader-styles')) {
            const style = document.createElement('style');
            style.id = 'downloader-styles';
            style.textContent = `
                @keyframes pulse {
                    0%, 100% { opacity: 1; }
                    50% { opacity: 0.5; }
                }
                @keyframes fadeIn {
                    from { opacity: 0; transform: translateY(-10px); }
                    to { opacity: 1; transform: translateY(0); }
                }
                @keyframes slideIn {
                    from { transform: translateX(100%); }
                    to { transform: translateX(0); }
                }
            `;
            document.head.appendChild(style);
        }
    }

    // åˆ›å»ºæ§åˆ¶é¢æ¿
    function createControlPanel() {
        if (document.getElementById('video-downloader-panel')) return;

        const panel = document.createElement('div');
        panel.id = 'video-downloader-panel';
        panel.style.cssText = `
            position: fixed;
            top: 80px;
            right: 20px;
            width: 400px;
            max-height: 70vh;
            background: linear-gradient(145deg, #1e3c72, #2a5298);
            border: none;
            border-radius: 15px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.4);
            z-index: 10000;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 13px;
            color: white;
            overflow: hidden;
            backdrop-filter: blur(10px);
            transform: translateX(100%);
            transition: transform 0.3s ease;
            animation: slideIn 0.3s ease forwards;
            display: ${isPanelVisible ? 'block' : 'none'};
        `;

        const header = document.createElement('div');
        header.style.cssText = `
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-bottom: 1px solid rgba(255,255,255,0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
        `;
        header.innerHTML = `
            <span>ğŸ¬ GYINGè§†é¢‘ä¸‹è½½å™¨</span>
            <button id="close-panel" style="background: rgba(255,255,255,0.2); border: none; color: white; width: 28px; height: 28px; border-radius: 50%; cursor: pointer; font-size: 18px; transition: all 0.2s ease;">Ã—</button>
        `;

        const content = document.createElement('div');
        content.id = 'panel-content';
        content.style.cssText = `
            padding: 15px;
            max-height: 500px;
            overflow-y: auto;
        `;

        panel.appendChild(header);
        panel.appendChild(content);
        document.body.appendChild(panel);

        // å…³é—­æŒ‰é’®äº‹ä»¶
        document.getElementById('close-panel').onclick = () => {
            togglePanel();
        };

        // å…³é—­æŒ‰é’®æ‚¬åœæ•ˆæœ
        const closeBtn = document.getElementById('close-panel');
        closeBtn.addEventListener('mouseenter', () => {
            closeBtn.style.background = 'rgba(239, 68, 68, 0.8)';
        });
        closeBtn.addEventListener('mouseleave', () => {
            closeBtn.style.background = 'rgba(255,255,255,0.2)';
        });

        updatePanel();
    }

    // åˆ‡æ¢é¢æ¿æ˜¾ç¤º/éšè—
    function togglePanel() {
        isPanelVisible = !isPanelVisible;
        const panel = document.getElementById('video-downloader-panel');

        if (isPanelVisible) {
            if (!panel) {
                createControlPanel();
            } else {
                panel.style.display = 'block';
                panel.style.transform = 'translateX(0)';
                updatePanel(); // æ›´æ–°å†…å®¹
            }
        } else {
            if (panel) {
                panel.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    panel.style.display = 'none';
                }, 300);
            }
        }

        // æ›´æ–°æŒ‰é’®çŠ¶æ€
        const button = document.getElementById('video-downloader-btn');
        if (button) {
            button.style.background = isPanelVisible
                ? 'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)'
                : 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
        }
    }

    // æ›´æ–°æœåŠ¡çŠ¶æ€æŒ‡ç¤ºå™¨
    function updateServiceIndicator() {
        const indicator = document.getElementById('service-indicator');
        if (indicator) {
            indicator.style.background = isServiceAvailable ? '#10b981' : '#ef4444';
            indicator.style.animation = isServiceAvailable ? 'none' : 'pulse 2s infinite';
        }
    }

    // æ›´æ–°é¢æ¿å†…å®¹
    function updatePanel() {
        const content = document.getElementById('panel-content');
        if (!content) return;

        let html = '';

        // æœåŠ¡çŠ¶æ€
        html += `
            <div style="margin-bottom: 15px; padding: 12px; background: rgba(255,255,255,0.1); border-radius: 10px;">
                <div style="font-weight: 600; margin-bottom: 8px; display: flex; align-items: center; gap: 8px;">
                    <span style="font-size: 16px;">${isServiceAvailable ? 'âœ…' : 'âŒ'}</span>
                    <span>æœåŠ¡çŠ¶æ€</span>
                </div>
                <div style="color: ${isServiceAvailable ? '#4ade80' : '#f87171'}; font-size: 12px;">
                    ${isServiceAvailable ? 'ğŸŸ¢ åç«¯æœåŠ¡æ­£å¸¸' : 'ğŸ”´ åç«¯æœåŠ¡ç¦»çº¿'}
                </div>
                <div style="font-size: 11px; color: #d1d5db; margin-top: 5px;">
                    ğŸ“º å½“å‰é¡µé¢: ${cleanTitle(document.title) || 'GYINGå½±è§†'}
                </div>
            </div>
        `;

        // M3U8 æµæ£€æµ‹
        if (detectedM3U8s.size > 0) {
            html += `
                <div style="margin-bottom: 15px;">
                    <div style="font-weight: 600; margin-bottom: 12px; color: #fbbf24; display: flex; align-items: center; gap: 8px;">
                        <span style="font-size: 16px;">ğŸ¬</span>
                        <span>æ£€æµ‹åˆ°M3U8æµ (${detectedM3U8s.size})</span>
                    </div>
            `;

            detectedM3U8s.forEach((m3u8, id) => {
                const shortUrl = m3u8.url.length > 50 ? m3u8.url.substring(0, 50) + '...' : m3u8.url;
                html += `
                    <div style="background: rgba(251, 191, 36, 0.15); border: 1px solid rgba(251, 191, 36, 0.4); margin: 10px 0; padding: 12px; border-radius: 10px; transition: all 0.2s ease;">
                        <div style="font-size: 12px; color: #fbbf24; margin-bottom: 6px; font-weight: 500;">ğŸ“» M3U8-${id}</div>
                        <div style="word-break: break-all; margin-bottom: 10px; font-size: 11px; color: #e5e7eb; background: rgba(0,0,0,0.2); padding: 6px; border-radius: 5px;">${shortUrl}</div>
                        <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                            <button onclick="downloadM3U8('${id}')" style="background: linear-gradient(135deg, #f59e0b, #d97706); color: white; border: none; padding: 8px 14px; border-radius: 6px; cursor: pointer; font-size: 11px; font-weight: 500; transition: all 0.2s ease;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">ğŸ“¥ ä¸‹è½½è§†é¢‘</button>
                            <button onclick="copyToClipboard('${m3u8.url}')" style="background: #6b7280; color: white; border: none; padding: 8px 14px; border-radius: 6px; cursor: pointer; font-size: 11px; transition: all 0.2s ease;" onmouseover="this.style.background='#4b5563'" onmouseout="this.style.background='#6b7280'">ğŸ“‹ å¤åˆ¶é“¾æ¥</button>
                        </div>
                    </div>
                `;
            });

            html += '</div>';
        }

        // æ‰‹åŠ¨è¾“å…¥ä¸‹è½½
        html += `
            <div style="margin-bottom: 15px;">
                <div style="font-weight: 600; margin-bottom: 12px; color: #a78bfa; display: flex; align-items: center; gap: 8px;">
                    <span style="font-size: 16px;">ğŸŒ</span>
                    <span>æ‰‹åŠ¨ä¸‹è½½</span>
                </div>
                <div style="background: rgba(167, 139, 250, 0.15); border: 1px solid rgba(167, 139, 250, 0.4); padding: 12px; border-radius: 10px;">
                    <input type="text" id="custom-url" placeholder="ç²˜è´´M3U8é“¾æ¥æˆ–è§†é¢‘é¡µé¢URL..." style="width: 100%; padding: 10px; border: 1px solid rgba(255,255,255,0.3); border-radius: 6px; background: rgba(255,255,255,0.1); color: white; font-size: 12px; margin-bottom: 10px; box-sizing: border-box;" />
                    <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                        <button onclick="downloadCustomUrl('video')" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed); color: white; border: none; padding: 8px 14px; border-radius: 6px; cursor: pointer; font-size: 11px; font-weight: 500; transition: all 0.2s ease;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">ğŸ“¥ ä¸‹è½½è§†é¢‘</button>
                        <button onclick="downloadCustomUrl('audio')" style="background: linear-gradient(135deg, #10b981, #059669); color: white; border: none; padding: 8px 14px; border-radius: 6px; cursor: pointer; font-size: 11px; font-weight: 500; transition: all 0.2s ease;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">ğŸµ ä¸‹è½½éŸ³é¢‘</button>
                    </div>
                </div>
            </div>
        `;

        // ç»Ÿè®¡ä¿¡æ¯
        html += `
            <div style="background: rgba(255,255,255,0.05); padding: 10px; border-radius: 8px; font-size: 11px; color: #9ca3af; text-align: center;">
                ğŸ“Š æœ¬æ¬¡ä¼šè¯: M3U8(${detectedM3U8s.size}) | è§†é¢‘(${detectedVideos.size})
            </div>
        `;

        if (detectedM3U8s.size === 0) {
            html += `
                <div style="text-align: center; color: #9ca3af; font-style: italic; padding: 30px 20px; background: rgba(255,255,255,0.05); border-radius: 10px; margin: 15px 0;">
                    <div style="font-size: 24px; margin-bottom: 10px;">ğŸ”</div>
                    <div>ç­‰å¾…æ£€æµ‹M3U8æµ...</div>
                    <div style="font-size: 10px; margin-top: 5px;">æ’­æ”¾è§†é¢‘åè‡ªåŠ¨æ£€æµ‹</div>
                </div>
            `;
        }

        content.innerHTML = html;
    }

    // ä¸‹è½½M3U8
    window.downloadM3U8 = async function(m3u8Id) {
        const m3u8 = detectedM3U8s.get(m3u8Id);
        if (!m3u8) return;

        if (!isServiceAvailable) {
            showNotification('âŒ ä¸‹è½½æœåŠ¡ä¸å¯ç”¨', 'è¯·ç¡®ä¿æœ¬åœ°æœåŠ¡è¿è¡Œåœ¨ http://localhost:8899', 'error');
            return;
        }

        try {
            const title = extractVideoTitle();
            console.log('ğŸ¯ æå–çš„æ ‡é¢˜:', title);

            showNotification('ğŸš€ å¼€å§‹ä¸‹è½½', `æ­£åœ¨ä¸‹è½½: ${title}`, 'info');

            const response = await fetch(`${SERVICE_URL}/download-m3u8`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    m3u8_url: m3u8.url,
                    page_url: window.location.href,
                    title: title,
                    headers: m3u8.headers || {}
                })
            });

            const result = await response.json();
            if (result.success) {
                showNotification('âœ… ä¸‹è½½å·²å¯åŠ¨', `æ–‡ä»¶å°†ä¿å­˜åˆ°: ${result.download_path}`, 'success');
            } else {
                showNotification('âŒ ä¸‹è½½å¤±è´¥', result.error, 'error');
            }
        } catch (error) {
            console.error('ä¸‹è½½M3U8é”™è¯¯:', error);
            showNotification('âŒ ä¸‹è½½å¤±è´¥', error.message, 'error');
        }
    };

    // ä¸‹è½½è‡ªå®šä¹‰URL
    window.downloadCustomUrl = async function(type) {
        if (!isServiceAvailable) {
            showNotification('âŒ ä¸‹è½½æœåŠ¡ä¸å¯ç”¨', 'è¯·ç¡®ä¿æœ¬åœ°æœåŠ¡è¿è¡Œåœ¨ http://localhost:8899', 'error');
            return;
        }

        const customUrl = document.getElementById('custom-url').value.trim();
        if (!customUrl) {
            showNotification('âš ï¸ è¯·è¾“å…¥URL', 'è¯·å…ˆè¾“å…¥M3U8é“¾æ¥æˆ–è§†é¢‘é¡µé¢URL', 'warning');
            return;
        }

        try {
            let endpoint, payload;

            if (isM3U8Url(customUrl)) {
                // M3U8é“¾æ¥
                endpoint = '/download-m3u8';
                payload = {
                    m3u8_url: customUrl,
                    page_url: window.location.href,
                    title: extractVideoTitle(),
                    headers: {}
                };
            } else {
                // æ™®é€šè§†é¢‘URL
                endpoint = '/download';
                payload = {
                    url: customUrl,
                    type: type,
                    quality: 'best'
                };
            }

            showNotification('ğŸš€ å¼€å§‹ä¸‹è½½', `æ­£åœ¨å¤„ç†: ${type === 'video' ? 'è§†é¢‘' : 'éŸ³é¢‘'}`, 'info');

            const response = await fetch(`${SERVICE_URL}${endpoint}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            const result = await response.json();
            if (result.success) {
                showNotification('âœ… ä¸‹è½½å·²å¯åŠ¨', `æ–‡ä»¶å°†ä¿å­˜åˆ°: ${result.download_path}`, 'success');
                document.getElementById('custom-url').value = ''; // æ¸…ç©ºè¾“å…¥æ¡†
            } else {
                showNotification('âŒ ä¸‹è½½å¤±è´¥', result.error, 'error');
            }
        } catch (error) {
            console.error('ä¸‹è½½å¤±è´¥:', error);
            showNotification('âŒ ä¸‹è½½å¤±è´¥', error.message, 'error');
        }
    };

    // å¤åˆ¶åˆ°å‰ªè´´æ¿
    window.copyToClipboard = function(text) {
        navigator.clipboard.writeText(text).then(() => {
            showNotification('ğŸ“‹ å·²å¤åˆ¶', 'é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
        }).catch(() => {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand('copy');
            document.body.removeChild(textarea);
            showNotification('ğŸ“‹ å·²å¤åˆ¶', 'é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
        });
    };

    // æ˜¾ç¤ºé€šçŸ¥
    function showNotification(title, message, type = 'info') {
        const notification = document.createElement('div');
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: ${type === 'success' ? 'linear-gradient(135deg, #10b981, #059669)' :
                         type === 'error' ? 'linear-gradient(135deg, #ef4444, #dc2626)' :
                         type === 'warning' ? 'linear-gradient(135deg, #f59e0b, #d97706)' :
                         'linear-gradient(135deg, #3b82f6, #2563eb)'};
            color: white;
            padding: 12px 20px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            z-index: 10002;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 13px;
            max-width: 400px;
            animation: fadeIn 0.3s ease;
        `;

        notification.innerHTML = `
            <div style="font-weight: 600; margin-bottom: 4px;">${title}</div>
            <div style="font-size: 12px; opacity: 0.9;">${message}</div>
        `;

        document.body.appendChild(notification);

        setTimeout(() => {
            notification.style.opacity = '0';
            notification.style.transform = 'translateX(-50%) translateY(-20px)';
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 300);
        }, 3000);
    }

    // æ‹¦æˆªç½‘ç»œè¯·æ±‚
    function interceptNetworkRequests() {
        const originalFetch = window.fetch;
        window.fetch = function(...args) {
            const url = args[0];
            if (typeof url === 'string') {
                checkAndAddUrl(url);
            }
            return originalFetch.apply(this, args);
        };

        const originalOpen = XMLHttpRequest.prototype.open;
        XMLHttpRequest.prototype.open = function(method, url, ...rest) {
            if (typeof url === 'string') {
                checkAndAddUrl(url);
            }
            return originalOpen.call(this, method, url, ...rest);
        };
    }

    // æ£€æŸ¥å¹¶æ·»åŠ URL
    function checkAndAddUrl(url) {
        if (!url || url.startsWith('data:') || url.startsWith('blob:')) return;

        try {
            const fullUrl = new URL(url, window.location.href).href;

            if (isM3U8Url(fullUrl)) {
                const id = `m3u8_${++m3u8Counter}`;
                if (!Array.from(detectedM3U8s.values()).some(m => m.url === fullUrl)) {
                    detectedM3U8s.set(id, {
                        url: fullUrl,
                        title: extractVideoTitle(),
                        detected: new Date().toLocaleTimeString()
                    });
                    console.log('ğŸ¬ æ£€æµ‹åˆ° M3U8:', fullUrl);
                    updatePanel();

                    // å¦‚æœé¢æ¿æœªæ˜¾ç¤ºï¼Œæ˜¾ç¤ºé€šçŸ¥
                    if (!isPanelVisible) {
                        showNotification('ğŸ¬ æ£€æµ‹åˆ°è§†é¢‘æµ', `å‘ç°M3U8æµï¼Œç‚¹å‡»å³ä¸Šè§’æŒ‰é’®æŸ¥çœ‹`, 'info');
                    }
                }
            }
        } catch (e) {
            // å¿½ç•¥æ— æ•ˆURL
        }
    }

    // æ‰«æé¡µé¢ç°æœ‰å…ƒç´ 
    function scanExistingElements() {
        document.querySelectorAll('video').forEach(video => {
            if (video.src) checkAndAddUrl(video.src);
            video.querySelectorAll('source').forEach(source => {
                if (source.src) checkAndAddUrl(source.src);
            });
        });
    }

    // è§‚å¯ŸDOMå˜åŒ–
    function observeDOM() {
        const observer = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
                mutation.addedNodes.forEach((node) => {
                    if (node.nodeType === Node.ELEMENT_NODE) {
                        if (node.tagName === 'VIDEO') {
                            if (node.src) checkAndAddUrl(node.src);
                        }
                        node.querySelectorAll && node.querySelectorAll('video').forEach(video => {
                            if (video.src) checkAndAddUrl(video.src);
                        });
                    }
                });
            });
        });

        observer.observe(document.body, {
            childList: true,
            subtree: true
        });
    }

    // åˆå§‹åŒ–
    async function init() {
        console.log('ğŸ¬ GYINGè§†é¢‘ä¸‹è½½å™¨å¯åŠ¨ä¸­...');

        // æ£€æŸ¥æœåŠ¡çŠ¶æ€
        await checkServiceAvailability();

        // åˆ›å»ºæ‚¬æµ®æŒ‰é’®
        createFloatingButton();

        // æ‹¦æˆªç½‘ç»œè¯·æ±‚
        interceptNetworkRequests();

        // æ‰«æç°æœ‰å…ƒç´ 
        scanExistingElements();

        // è§‚å¯ŸDOMå˜åŒ–
        observeDOM();

        // å®šæœŸé‡æ–°æ‰«æ
        setInterval(() => {
            scanExistingElements();
        }, 3000);

        // å®šæœŸæ£€æŸ¥æœåŠ¡çŠ¶æ€
        setInterval(async () => {
            const wasAvailable = isServiceAvailable;
            await checkServiceAvailability();
            if (wasAvailable !== isServiceAvailable) {
                updateServiceIndicator();
                updatePanel();
            }
        }, 10000);

        console.log('âœ… GYINGè§†é¢‘ä¸‹è½½å™¨åˆå§‹åŒ–å®Œæˆ');
    }

    // é¡µé¢åŠ è½½å®Œæˆåå¯åŠ¨
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
    } else {
        init();
    }
})();
