// ==UserScript==
// @name         YouTubeè§†é¢‘ä¸‹è½½åŠ©æ‰‹ (æ’­æ”¾åˆ—è¡¨æ‰¹é‡ä¸‹è½½ç‰ˆ)
// @namespace    http://tampermonkey.net/
// @version      4.7
// @description  åœ¨YouTubeè§†é¢‘é¡µé¢ã€é¦–é¡µã€è®¢é˜…é¡µã€æ’­æ”¾åˆ—è¡¨å’ŒçŸ­è§†é¢‘æ·»åŠ ä¸‹è½½æŒ‰é’®ï¼Œæ”¯æŒæ’­æ”¾åˆ—è¡¨æ‰¹é‡ä¸‹è½½
// @author       You
// @match        https://www.youtube.com/*
// @connect      localhost
// @grant        GM_xmlhttpRequest
// @grant        unsafeWindow
// @run-at       document-end
// ==/UserScript==

(function() {
    'use strict';

    const API_BASE = 'http://localhost:8899';

    // Trusted Types ç­–ç•¥å¤„ç†
    let trustedPolicy = null;
    try {
        if (window.trustedTypes) {
            trustedPolicy = window.trustedTypes.createPolicy('youtube-downloader', {
                createHTML: (string) => string,
                createScript: (string) => string,
                createScriptURL: (string) => string
            });
        }
    } catch (e) {
        console.log('Trusted Types ç­–ç•¥åˆ›å»ºå¤±è´¥ï¼Œä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆ');
    }

    // åˆ›å»ºæ ·å¼è¡¨
    function injectStyles() {
        if (document.getElementById('yt-downloader-styles')) return;

        const style = document.createElement('style');
        style.id = 'yt-downloader-styles';
        style.textContent = `
            .yt-download-btns {
                position: absolute !important;
                top: 8px !important;
                left: 8px !important;
                z-index: 99999 !important;
                display: flex !important;
                gap: 4px !important;
                pointer-events: auto !important;
                background: rgba(0, 0, 0, 0.8) !important;
                border-radius: 6px !important;
                padding: 4px !important;
                backdrop-filter: blur(4px) !important;
            }

            .yt-download-btn {
                background: rgba(255, 0, 0, 0.95) !important;
                color: white !important;
                border: none !important;
                padding: 6px 8px !important;
                border-radius: 4px !important;
                cursor: pointer !important;
                font-size: 14px !important;
                font-weight: bold !important;
                min-width: 28px !important;
                height: 28px !important;
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
                pointer-events: auto !important;
                position: relative !important;
                z-index: 99999 !important;
                box-shadow: 0 2px 4px rgba(0,0,0,0.3) !important;
                transition: all 0.2s !important;
                opacity: 0.95;
            }

            .yt-download-btn:hover {
                opacity: 1 !important;
                transform: scale(1.05) !important;
            }

            .yt-audio-btn {
                background: rgba(255, 102, 153, 0.95) !important;
            }

            .yt-player-buttons {
                position: absolute !important;
                top: 15px !important;
                left: 15px !important;
                z-index: 99999 !important;
                display: flex !important;
                gap: 8px !important;
                pointer-events: auto !important;
            }

            .yt-player-btn {
                background: rgba(255, 0, 0, 0.95) !important;
                color: white !important;
                border: none !important;
                padding: 10px 15px !important;
                border-radius: 6px !important;
                cursor: pointer !important;
                font-size: 13px !important;
                font-weight: bold !important;
                pointer-events: auto !important;
                z-index: 99999 !important;
                box-shadow: 0 2px 6px rgba(0,0,0,0.3) !important;
            }

            .yt-player-audio-btn {
                background: rgba(255, 102, 153, 0.95) !important;
            }

            /* æ’­æ”¾åˆ—è¡¨æ‰¹é‡ä¸‹è½½æŒ‰é’®æ ·å¼ */
            .yt-playlist-batch-btns {
                position: absolute !important;
                top: -15px !important;
                right: 15px !important;
                z-index: 999999 !important;
                display: flex !important;
                flex-direction: row !important;
                gap: 6px !important;
                pointer-events: auto !important;
                background: rgba(255, 255, 255, 0.98) !important;
                border-radius: 8px !important;
                padding: 6px !important;
                box-shadow: 0 4px 16px rgba(0,0,0,0.4) !important;
                border: 2px solid rgba(255,0,0,0.3) !important;
                backdrop-filter: blur(4px) !important;
            }

            .yt-playlist-batch-btn {
                background: rgba(255, 0, 0, 0.9) !important;
                color: white !important;
                border: 1px solid rgba(255, 255, 255, 0.3) !important;
                padding: 6px 10px !important;
                border-radius: 6px !important;
                cursor: pointer !important;
                font-size: 11px !important;
                font-weight: bold !important;
                min-width: 60px !important;
                height: 28px !important;
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
                pointer-events: auto !important;
                position: relative !important;
                z-index: 999999 !important;
                box-shadow: 0 2px 6px rgba(0,0,0,0.6) !important;
                transition: all 0.2s ease !important;
                opacity: 1 !important;
                font-family: Arial, sans-serif !important;
            }

            .yt-playlist-batch-btn:hover {
                opacity: 1 !important;
                transform: scale(1.05) !important;
                box-shadow: 0 4px 12px rgba(0,0,0,0.8) !important;
            }

            .yt-playlist-batch-audio-btn {
                background: rgba(255, 102, 153, 0.9) !important;
            }

            .yt-playlist-batch-video-btn {
                background: rgba(255, 69, 0, 0.9) !important;
            }

            /* è§†é¢‘æŽ¨èåŒºåŸŸä¸‹è½½æŒ‰é’®æ ·å¼ */
            .yt-recommendation-btns {
                position: absolute !important;
                top: 8px !important;
                left: 8px !important;
                z-index: 99999 !important;
                display: flex !important;
                gap: 4px !important;
                pointer-events: auto !important;
                background: rgba(0, 0, 0, 0.8) !important;
                border-radius: 6px !important;
                padding: 4px !important;
                backdrop-filter: blur(4px) !important;
            }

            .yt-recommendation-btn {
                background: rgba(255, 0, 0, 0.9) !important;
                color: white !important;
                border: none !important;
                padding: 4px 6px !important;
                border-radius: 4px !important;
                cursor: pointer !important;
                font-size: 11px !important;
                font-weight: bold !important;
                min-width: 24px !important;
                height: 24px !important;
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
                pointer-events: auto !important;
                position: relative !important;
                z-index: 99999 !important;
                box-shadow: 0 1px 4px rgba(0,0,0,0.3) !important;
                transition: all 0.2s ease !important;
                opacity: 0.95;
            }

            .yt-recommendation-btn:hover {
                opacity: 1 !important;
                transform: scale(1.1) !important;
            }

            .yt-recommendation-audio-btn {
                background: rgba(255, 102, 153, 0.9) !important;
            }

            /* çŸ­è§†é¢‘æŒ‰é’®æ ·å¼ */
            .yt-shorts-btns {
                position: absolute !important;
                top: 8px !important;
                left: 8px !important;
                z-index: 999999 !important;
                display: flex !important;
                flex-direction: row !important;
                gap: 4px !important;
                pointer-events: auto !important;
                background: rgba(0, 0, 0, 0.8) !important;
                border-radius: 6px !important;
                padding: 4px !important;
                backdrop-filter: blur(4px) !important;
            }

            .yt-shorts-btn {
                background: rgba(255, 0, 0, 0.9) !important;
                color: white !important;
                border: 1px solid rgba(255, 255, 255, 0.3) !important;
                padding: 4px 6px !important;
                border-radius: 4px !important;
                cursor: pointer !important;
                font-size: 11px !important;
                font-weight: bold !important;
                min-width: 24px !important;
                height: 24px !important;
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
                pointer-events: auto !important;
                position: relative !important;
                z-index: 999999 !important;
                box-shadow: 0 2px 6px rgba(0,0,0,0.6) !important;
                transition: all 0.2s ease !important;
                opacity: 1 !important;
                font-family: Arial, sans-serif !important;
            }

            .yt-shorts-btn:hover {
                opacity: 1 !important;
                transform: scale(1.15) !important;
                box-shadow: 0 4px 12px rgba(0,0,0,0.8) !important;
            }

            .yt-shorts-audio-btn {
                background: rgba(255, 102, 153, 0.9) !important;
            }

            .yt-shorts-video-btn {
                background: rgba(255, 0, 0, 0.9) !important;
            }

            /* çŸ­è§†é¢‘æ’­æ”¾å™¨æŒ‰é’®æ ·å¼ */
            .yt-shorts-player-btns {
                position: fixed !important;
                top: 15px !important;
                left: 15px !important;
                z-index: 999999 !important;
                display: flex !important;
                flex-direction: row !important;
                gap: 8px !important;
                pointer-events: auto !important;
                background: rgba(0, 0, 0, 0.8) !important;
                border-radius: 8px !important;
                padding: 6px !important;
                backdrop-filter: blur(4px) !important;
            }

            .yt-shorts-player-btn {
                background: rgba(255, 0, 0, 0.85) !important;
                color: white !important;
                border: 1px solid rgba(255, 255, 255, 0.3) !important;
                padding: 6px 10px !important;
                border-radius: 6px !important;
                cursor: pointer !important;
                font-size: 12px !important;
                font-weight: bold !important;
                min-width: 60px !important;
                height: 32px !important;
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
                pointer-events: auto !important;
                position: relative !important;
                z-index: 999999 !important;
                box-shadow: 0 2px 8px rgba(0,0,0,0.5) !important;
                transition: all 0.2s ease !important;
                opacity: 0.95 !important;
                font-family: Arial, sans-serif !important;
            }

            .yt-shorts-player-btn:hover {
                opacity: 1 !important;
                transform: scale(1.05) !important;
                box-shadow: 0 4px 12px rgba(0,0,0,0.7) !important;
            }

            .yt-shorts-player-audio-btn {
                background: rgba(255, 102, 153, 0.85) !important;
            }

            .yt-shorts-player-video-btn {
                background: rgba(255, 0, 0, 0.85) !important;
            }

            /* æ’­æ”¾åˆ—è¡¨è§†é¢‘æŒ‰é’®æ ·å¼ */
            .yt-playlist-btns {
                position: absolute !important;
                top: 8px !important;
                left: 8px !important;
                z-index: 99999 !important;
                display: flex !important;
                gap: 4px !important;
                pointer-events: auto !important;
                background: rgba(0, 0, 0, 0.8) !important;
                border-radius: 6px !important;
                padding: 4px !important;
                backdrop-filter: blur(4px) !important;
            }

            .yt-playlist-btn {
                background: rgba(255, 0, 0, 0.95) !important;
                color: white !important;
                border: none !important;
                padding: 6px 8px !important;
                border-radius: 4px !important;
                cursor: pointer !important;
                font-size: 12px !important;
                font-weight: bold !important;
                min-width: 26px !important;
                height: 26px !important;
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
                pointer-events: auto !important;
                position: relative !important;
                z-index: 99999 !important;
                box-shadow: 0 2px 4px rgba(0,0,0,0.3) !important;
                transition: opacity 0.2s !important;
                opacity: 0.9;
            }

            .yt-playlist-btn:hover {
                opacity: 1 !important;
            }

            .yt-playlist-audio-btn {
                background: rgba(255, 102, 153, 0.95) !important;
            }

            /* å¼ºåˆ¶æ˜¾ç¤º - è¦†ç›–ä»»ä½•éšè—æ ·å¼ */
            .yt-shorts-btns,
            .yt-shorts-player-btns,
            .yt-playlist-batch-btns,
            .yt-recommendation-btns,
            .yt-download-btns,
            .yt-playlist-btns {
                opacity: 1 !important;
                visibility: visible !important;
                display: flex !important;
                pointer-events: auto !important;
                transform: translateZ(0) !important;
            }

            /* ç¡®ä¿æŒ‰é’®å®¹å™¨ä¸è¢«é®æŒ¡ */
            .yt-shorts-btns *,
            .yt-shorts-player-btns *,
            .yt-playlist-batch-btns *,
            .yt-recommendation-btns *,
            .yt-download-btns *,
            .yt-playlist-btns * {
                pointer-events: auto !important;
                z-index: 999999 !important;
                opacity: 1 !important;
                visibility: visible !important;
            }

            /* ç‰¹æ®Šæƒ…å†µå¤„ç† - ç¡®ä¿åœ¨æ‰€æœ‰å®¹å™¨ä¸­éƒ½èƒ½æ˜¾ç¤º */
            ytd-rich-item-renderer .yt-shorts-btns,
            ytd-rich-item-renderer .yt-download-btns,
            yt-lockup-view-model .yt-download-btns,
            yt-lockup-view-model .yt-shorts-btns,
            ytm-shorts-lockup-view-model .yt-shorts-btns,
            .shortsLockupViewModelHost .yt-shorts-btns,
            ytd-playlist-panel-renderer .yt-playlist-batch-btns {
                display: flex !important;
                opacity: 1 !important;
                visibility: visible !important;
                position: absolute !important;
                z-index: 999999 !important;
                transform: translateZ(0) !important;
            }
        `;

        document.head.appendChild(style);
    }

    // æå–è§†é¢‘IDå’Œæž„å»ºURLï¼ˆæ”¹è¿›ç‰ˆæœ¬ï¼‰
    function extractVideoUrl(element, forceRemovePlaylist = true) {
        // æ›´å…¨é¢çš„é“¾æŽ¥é€‰æ‹©å™¨
        const linkSelectors = [
            'a[href*="/watch?v="]',
            'a[href*="/shorts/"]',
            'a#video-title-link',
            'a#video-title',
            'h3 a',
            'a#thumbnail',
            'a.yt-lockup-view-model__content-image',
            '.yt-lockup-view-model__content-image',
            'a.ytd-thumbnail',
            '.shortsLockupViewModelHostEndpoint',
            'a.yt-lockup-metadata-view-model__title'
        ];

        let linkElement = null;
        for (const selector of linkSelectors) {
            linkElement = element.querySelector(selector);
            if (linkElement) break;
        }

        if (!linkElement) {
            // å¦‚æžœè¿˜æ²¡æ‰¾åˆ°ï¼Œå°è¯•æŸ¥æ‰¾çˆ¶å…ƒç´ ä¸­çš„é“¾æŽ¥
            const parent = element.closest('ytd-rich-item-renderer, ytd-video-renderer, ytd-compact-video-renderer');
            if (parent) {
                for (const selector of linkSelectors) {
                    linkElement = parent.querySelector(selector);
                    if (linkElement) break;
                }
            }
        }

        if (!linkElement) return null;

        let videoUrl = linkElement.href;
        if (!videoUrl) {
            const href = linkElement.getAttribute('href');
            if (href && (href.includes('/watch?v=') || href.includes('/shorts/'))) {
                videoUrl = 'https://www.youtube.com' + href;
            }
        }

        // å¦‚æžœæ˜¯shorts URLï¼Œè½¬æ¢ä¸ºwatch URL
        if (videoUrl && videoUrl.includes('/shorts/')) {
            const videoId = videoUrl.split('/shorts/')[1].split('?')[0];
            videoUrl = `https://www.youtube.com/watch?v=${videoId}`;
        }

        // å¼ºåˆ¶ç§»é™¤æ’­æ”¾åˆ—è¡¨å‚æ•°ï¼Œç¡®ä¿åªä¸‹è½½å•ä¸ªè§†é¢‘
        if (forceRemovePlaylist && videoUrl && videoUrl.includes('list=')) {
            const url = new URL(videoUrl);
            url.searchParams.delete('list');
            url.searchParams.delete('index');
            videoUrl = url.toString();
        }

        return videoUrl && (videoUrl.includes('/watch?v=') || videoUrl.includes('/shorts/')) ? videoUrl : null;
    }

    // ä»Žå½“å‰é¡µé¢URLæå–å•ä¸ªè§†é¢‘URLï¼ˆä¸åŒ…å«æ’­æ”¾åˆ—è¡¨å‚æ•°ï¼‰
    function extractSingleVideoUrl() {
        const url = new URL(window.location.href);
        if (url.pathname.includes('/watch')) {
            // ç§»é™¤æ’­æ”¾åˆ—è¡¨å‚æ•°
            url.searchParams.delete('list');
            url.searchParams.delete('index');
            return url.toString();
        } else if (url.pathname.includes('/shorts/')) {
            const videoId = url.pathname.split('/shorts/')[1];
            return `https://www.youtube.com/watch?v=${videoId}`;
        }
        return null;
    }

    // æå–æ’­æ”¾åˆ—è¡¨URL
    function extractPlaylistUrl() {
        const urlParams = new URLSearchParams(window.location.search);
        const listId = urlParams.get('list');
        if (listId) {
            return `https://www.youtube.com/playlist?list=${listId}`;
        }
        return null;
    }

    // æ£€æŸ¥æ˜¯å¦ä¸ºæ’­æ”¾åˆ—è¡¨é¡µé¢
    function isPlaylistPage() {
        const hasListParam = window.location.search.includes('list=');
        console.log('ðŸ” æ’­æ”¾åˆ—è¡¨æ£€æŸ¥:', {
            url: window.location.href,
            hasListParam: hasListParam,
            search: window.location.search
        });
        return hasListParam;
    }

    // åˆ›å»ºä¸‹è½½æŒ‰é’®
    function createDownloadButton(type, icon, title, bgClass = '') {
        const btn = document.createElement('button');
        btn.textContent = icon;
        btn.title = title;
        btn.type = 'button';
        btn.className = `${type} ${bgClass}`;
        return btn;
    }

    // æ·»åŠ æ’­æ”¾åˆ—è¡¨æ‰¹é‡ä¸‹è½½æŒ‰é’®ï¼ˆæ”¹è¿›ç‰ˆæœ¬ï¼‰
    function addPlaylistBatchButtons() {
        if (!isPlaylistPage()) {
            console.log('âŒ ä¸æ˜¯æ’­æ”¾åˆ—è¡¨é¡µé¢ï¼Œè·³è¿‡æ·»åŠ æ‰¹é‡ä¸‹è½½æŒ‰é’®');
            return false;
        }

        const playlistPanels = document.querySelectorAll('ytd-playlist-panel-renderer:not([data-batch-download-added])');
        console.log(`ðŸ” æ‰¾åˆ° ${playlistPanels.length} ä¸ªæ’­æ”¾åˆ—è¡¨é¢æ¿`);

        playlistPanels.forEach((panel, index) => {
            try {
                if (panel.hasAttribute('data-batch-download-added')) {
                    return;
                }
                panel.setAttribute('data-batch-download-added', 'true');

                const playlistUrl = extractPlaylistUrl();
                if (!playlistUrl) {
                    console.log('âŒ æœªæ‰¾åˆ°æ’­æ”¾åˆ—è¡¨URL');
                    return;
                }

                console.log(`ðŸŽ¯ ä¸ºæ’­æ”¾åˆ—è¡¨é¢æ¿ ${index} æ·»åŠ æ‰¹é‡ä¸‹è½½æŒ‰é’®, URL:`, playlistUrl);

                if (panel.querySelector('.yt-playlist-batch-btns')) {
                    console.log(`æ’­æ”¾åˆ—è¡¨é¢æ¿ ${index} å·²æœ‰æ‰¹é‡ä¸‹è½½æŒ‰é’®`);
                    return;
                }

                const btnContainer = document.createElement('div');
                btnContainer.className = 'yt-playlist-batch-btns';

                const audioBtn = createDownloadButton('yt-playlist-batch-btn', 'ðŸŽµæ‰¹é‡', 'æ‰¹é‡ä¸‹è½½æ’­æ”¾åˆ—è¡¨éŸ³é¢‘', 'yt-playlist-batch-audio-btn');
                audioBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    e.stopImmediatePropagation();
                    console.log('ðŸŽµ ç‚¹å‡»æ‰¹é‡éŸ³é¢‘ä¸‹è½½');
                    downloadPlaylist(playlistUrl, 'audio');
                }, true);

                const videoBtn = createDownloadButton('yt-playlist-batch-btn', 'ðŸŽ¬æ‰¹é‡', 'æ‰¹é‡ä¸‹è½½æ’­æ”¾åˆ—è¡¨è§†é¢‘', 'yt-playlist-batch-video-btn');
                videoBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    e.stopImmediatePropagation();
                    console.log('ðŸŽ¬ ç‚¹å‡»æ‰¹é‡è§†é¢‘ä¸‹è½½');
                    showPlaylistQualityMenu(playlistUrl);
                }, true);

                btnContainer.appendChild(audioBtn);
                btnContainer.appendChild(videoBtn);

                panel.style.position = 'relative';
                panel.style.overflow = 'visible';
                panel.appendChild(btnContainer);

                console.log(`âœ… å·²ä¸ºæ’­æ”¾åˆ—è¡¨é¢æ¿ ${index} æ·»åŠ æ‰¹é‡ä¸‹è½½æŒ‰é’®`);
            } catch (error) {
                console.error(`âŒ å¤„ç†æ’­æ”¾åˆ—è¡¨é¢æ¿ ${index} æ—¶å‡ºé”™:`, error);
            }
        });
    }

    // ä¸ºè§†é¢‘æŽ¨èåŒºåŸŸæ·»åŠ ä¸‹è½½æŒ‰é’®ï¼ˆæ”¹è¿›ç‰ˆæœ¬ï¼‰
    function addButtonsToRecommendations() {
        const recommendationSelectors = [
            'ytd-compact-video-renderer:not([data-recommendation-download-added])',
            'ytd-video-meta-block:not([data-recommendation-download-added])',
            '.ytd-watch-next-secondary-results-renderer .ytd-compact-video-renderer:not([data-recommendation-download-added])'
        ];

        let recommendationCards = [];
        recommendationSelectors.forEach(selector => {
            try {
                const cards = document.querySelectorAll(selector);
                cards.forEach(card => {
                    const isInSecondaryResults = card.closest('#secondary') ||
                                               card.closest('.watch-sidebar') ||
                                               card.closest('ytd-watch-next-secondary-results-renderer') ||
                                               card.closest('#related');

                    if (isInSecondaryResults && !recommendationCards.includes(card)) {
                        recommendationCards.push(card);
                    }
                });
            } catch (e) {
                // å¿½ç•¥é€‰æ‹©å™¨é”™è¯¯
            }
        });

        console.log(`ðŸ“º æ‰¾åˆ° ${recommendationCards.length} ä¸ªæŽ¨èè§†é¢‘å¡ç‰‡`);

        recommendationCards.forEach((card, index) => {
            try {
                if (card.hasAttribute('data-recommendation-download-added')) {
                    return;
                }
                card.setAttribute('data-recommendation-download-added', 'true');

                const videoUrl = extractVideoUrl(card, true);
                if (!videoUrl) return;

                let thumbnailContainer = card.querySelector('ytd-thumbnail') ||
                                       card.querySelector('#thumbnail') ||
                                       card.querySelector('.ytd-thumbnail');

                if (!thumbnailContainer || card.querySelector('.yt-recommendation-btns')) {
                    return;
                }

                const btnContainer = document.createElement('div');
                btnContainer.className = 'yt-recommendation-btns';

                const audioBtn = createDownloadButton('yt-recommendation-btn', 'â™ª', 'ä¸‹è½½éŸ³é¢‘ (MP3)', 'yt-recommendation-audio-btn');
                audioBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    e.stopImmediatePropagation();
                    downloadMedia(videoUrl, 'audio');
                }, true);

                const videoBtn = createDownloadButton('yt-recommendation-btn', 'â–¼', 'ä¸‹è½½è§†é¢‘');
                videoBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    e.stopImmediatePropagation();
                    showQualityMenu(videoUrl);
                }, true);

                btnContainer.appendChild(audioBtn);
                btnContainer.appendChild(videoBtn);

                thumbnailContainer.style.position = 'relative';
                thumbnailContainer.style.overflow = 'visible';
                thumbnailContainer.appendChild(btnContainer);

                console.log(`âœ… å·²ä¸ºæŽ¨èè§†é¢‘å¡ç‰‡ ${index} æ·»åŠ ä¸‹è½½æŒ‰é’®`);
            } catch (error) {
                console.error(`âŒ å¤„ç†æŽ¨èè§†é¢‘å¡ç‰‡ ${index} æ—¶å‡ºé”™:`, error);
            }
        });
    }

    // ä¸ºæ™®é€šè§†é¢‘å¡ç‰‡æ·»åŠ ä¸‹è½½æŒ‰é’®ï¼ˆæ”¹è¿›ç‰ˆæœ¬ï¼‰
    function addButtonsToVideoCards() {
        const videoCards = document.querySelectorAll(`
            ytd-video-renderer:not([data-download-added]):not(:has(.yt-download-btns)),
            ytd-compact-video-renderer:not([data-download-added]):not(:has(.yt-download-btns)),
            ytd-grid-video-renderer:not([data-download-added]):not(:has(.yt-download-btns)),
            ytd-rich-item-renderer:not([data-download-added]):not(:has(ytm-shorts-lockup-view-model)):not(:has(.yt-download-btns)):not(:has(.yt-shorts-btns)),
            ytd-movie-renderer:not([data-download-added]):not(:has(.yt-download-btns))
        `);

        console.log(`ðŸ“¹ æ‰¾åˆ° ${videoCards.length} ä¸ªæ™®é€šè§†é¢‘å¡ç‰‡`);

        videoCards.forEach((card, index) => {
            try {
                card.setAttribute('data-download-added', 'true');

                const videoUrl = extractVideoUrl(card, true);
                if (!videoUrl) return;

                // æ”¹è¿›çš„ç¼©ç•¥å›¾å®¹å™¨æŸ¥æ‰¾
                let thumbnailContainer = card.querySelector('yt-thumbnail-view-model') ||
                                       card.querySelector('ytd-thumbnail') ||
                                       card.querySelector('#thumbnail') ||
                                       card.querySelector('.ytd-thumbnail') ||
                                       card.querySelector('.yt-lockup-view-model__content-image') ||
                                       card.querySelector('a[href*="/watch"]') ||
                                       card.querySelector('#dismissible');

                if (!thumbnailContainer || card.querySelector('.yt-download-btns')) return;

                const btnContainer = document.createElement('div');
                btnContainer.className = 'yt-download-btns';

                const audioBtn = createDownloadButton('yt-download-btn', 'ðŸŽµ', 'ä¸‹è½½éŸ³é¢‘ (MP3)', 'yt-audio-btn');
                audioBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    e.stopImmediatePropagation();
                    downloadMedia(videoUrl, 'audio');
                }, true);

                const videoBtn = createDownloadButton('yt-download-btn', 'ðŸŽ¬', 'ä¸‹è½½è§†é¢‘');
                videoBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    e.stopImmediatePropagation();
                    showQualityMenu(videoUrl);
                }, true);

                btnContainer.appendChild(audioBtn);
                btnContainer.appendChild(videoBtn);

                thumbnailContainer.style.position = 'relative';
                thumbnailContainer.style.overflow = 'visible';
                thumbnailContainer.appendChild(btnContainer);

                console.log(`âœ… å·²ä¸ºæ™®é€šè§†é¢‘å¡ç‰‡ ${index} æ·»åŠ ä¸‹è½½æŒ‰é’®`);
            } catch (error) {
                console.error(`âŒ å¤„ç†æ™®é€šå¡ç‰‡ ${index} æ—¶å‡ºé”™:`, error);
            }
        });
    }

    // ä¸ºçŸ­è§†é¢‘æ·»åŠ ä¸‹è½½æŒ‰é’®ï¼ˆæ”¹è¿›ç‰ˆæœ¬ï¼‰
    function addButtonsToShorts() {
        const shortsSelectors = [
            'ytd-rich-item-renderer:has(ytm-shorts-lockup-view-model):not([data-shorts-download-added]):not(:has(.yt-shorts-btns))',
            'ytm-shorts-lockup-view-model:not([data-shorts-download-added]):not(:has(.yt-shorts-btns))',
            'ytd-rich-item-renderer[is-slim-media]:not([data-shorts-download-added]):not(:has(.yt-shorts-btns))',
            'ytd-rich-item-renderer:has(a[href*="/shorts/"]):not([data-shorts-download-added]):not(:has(.yt-shorts-btns))'
        ];

        let shortsCards = [];
        shortsSelectors.forEach(selector => {
            try {
                const cards = document.querySelectorAll(selector);
                cards.forEach(card => {
                    if (!shortsCards.includes(card)) {
                        shortsCards.push(card);
                    }
                });
            } catch (e) {
                // å¿½ç•¥é€‰æ‹©å™¨é”™è¯¯
            }
        });

        console.log(`ðŸ©³ æ‰¾åˆ° ${shortsCards.length} ä¸ªçŸ­è§†é¢‘å¡ç‰‡`);

        shortsCards.forEach((card, index) => {
            try {
                if (card.hasAttribute('data-shorts-download-added')) return;
                card.setAttribute('data-shorts-download-added', 'true');

                const linkElement = card.querySelector('a[href*="/shorts/"]') ||
                                   card.querySelector('.shortsLockupViewModelHostEndpoint') ||
                                   card.querySelector('ytm-shorts-lockup-view-model a') ||
                                   card.querySelector('a.reel-item-endpoint');

                if (!linkElement) return;

                let videoUrl = linkElement.href;
                if (!videoUrl) {
                    const href = linkElement.getAttribute('href');
                    if (href && href.includes('/shorts/')) {
                        videoUrl = 'https://www.youtube.com' + href;
                    }
                }

                if (!videoUrl || !videoUrl.includes('/shorts/')) return;

                const videoId = videoUrl.split('/shorts/')[1].split('?')[0];
                const watchUrl = `https://www.youtube.com/watch?v=${videoId}`;

                if (card.querySelector('.yt-shorts-btns')) return;

                // æŸ¥æ‰¾æ›´å¥½çš„å®¹å™¨ä½ç½®
                let thumbnailContainer = card.querySelector('yt-thumbnail-view-model') ||
                                       card.querySelector('ytm-shorts-lockup-view-model') ||
                                       card.querySelector('.yt-lockup-view-model__content-image') ||
                                       linkElement;

                const btnContainer = document.createElement('div');
                btnContainer.className = 'yt-shorts-btns';

                const audioBtn = createDownloadButton('yt-shorts-btn', 'â™ª', 'ä¸‹è½½éŸ³é¢‘ (MP3)', 'yt-shorts-audio-btn');
                audioBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    e.stopImmediatePropagation();
                    downloadMedia(watchUrl, 'audio');
                }, true);

                const videoBtn = createDownloadButton('yt-shorts-btn', 'â–¼', 'ä¸‹è½½è§†é¢‘', 'yt-shorts-video-btn');
                videoBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    e.stopImmediatePropagation();
                    showQualityMenu(watchUrl);
                }, true);

                btnContainer.appendChild(audioBtn);
                btnContainer.appendChild(videoBtn);

                if (thumbnailContainer) {
                    thumbnailContainer.style.position = 'relative';
                    thumbnailContainer.style.overflow = 'visible';
                    thumbnailContainer.appendChild(btnContainer);
                } else {
                    card.style.position = 'relative';
                    card.style.overflow = 'visible';
                    card.appendChild(btnContainer);
                }

                console.log(`âœ… å·²ä¸ºçŸ­è§†é¢‘å¡ç‰‡ ${index} æ·»åŠ ä¸‹è½½æŒ‰é’®`);
            } catch (error) {
                console.error(`âŒ å¤„ç†çŸ­è§†é¢‘å¡ç‰‡ ${index} æ—¶å‡ºé”™:`, error);
            }
        });
    }

    // ä¸ºçŸ­è§†é¢‘æ’­æ”¾å™¨æ·»åŠ ä¸‹è½½æŒ‰é’®
    function addButtonsToShortsPlayer() {
        if (!window.location.pathname.includes('/shorts/')) return;
        if (document.getElementById('yt-shorts-player-download-buttons')) return;

        const shortsPlayer = document.querySelector('#shorts-player') ||
                            document.querySelector('.html5-video-player') ||
                            document.querySelector('ytd-shorts-player') ||
                            document.querySelector('#player-container');

        if (!shortsPlayer) return;

        const videoId = window.location.pathname.split('/shorts/')[1];
        if (!videoId) return;

        const videoUrl = `https://www.youtube.com/watch?v=${videoId}`;

        const buttonContainer = document.createElement('div');
        buttonContainer.id = 'yt-shorts-player-download-buttons';
        buttonContainer.className = 'yt-shorts-player-btns';

        const audioBtn = document.createElement('button');
        audioBtn.className = 'yt-shorts-player-btn yt-shorts-player-audio-btn';
        audioBtn.textContent = 'ðŸŽµ éŸ³é¢‘';
        audioBtn.type = 'button';
        audioBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            downloadMedia(videoUrl, 'audio');
        }, true);

        const videoBtn = document.createElement('button');
        videoBtn.className = 'yt-shorts-player-btn yt-shorts-player-video-btn';
        videoBtn.textContent = 'ðŸŽ¬ è§†é¢‘';
        videoBtn.type = 'button';
        videoBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            showQualityMenu(videoUrl);
        }, true);

        buttonContainer.appendChild(audioBtn);
        buttonContainer.appendChild(videoBtn);
        document.body.appendChild(buttonContainer);

        console.log('âœ… å·²ä¸ºçŸ­è§†é¢‘æ’­æ”¾å™¨æ·»åŠ ä¸‹è½½æŒ‰é’®');
    }

    // ä¸ºæ’­æ”¾åˆ—è¡¨è§†é¢‘æ·»åŠ ä¸‹è½½æŒ‰é’®
    function addButtonsToPlaylistVideos() {
        const playlistVideos = document.querySelectorAll(`
            ytd-playlist-panel-video-renderer:not([data-download-added])
        `);

        console.log(`ðŸ“‹ æ‰¾åˆ° ${playlistVideos.length} ä¸ªæ’­æ”¾åˆ—è¡¨è§†é¢‘`);

        playlistVideos.forEach((video, index) => {
            try {
                video.setAttribute('data-download-added', 'true');

                const videoUrl = extractVideoUrl(video, true);
                if (!videoUrl) return;

                const thumbnailContainer = video.querySelector('#thumbnail-container') ||
                                         video.querySelector('ytd-thumbnail') ||
                                         video.querySelector('#thumbnail');

                if (!thumbnailContainer) return;

                const btnContainer = document.createElement('div');
                btnContainer.className = 'yt-playlist-btns';

                const audioBtn = createDownloadButton('yt-playlist-btn', 'ðŸŽµ', 'ä¸‹è½½éŸ³é¢‘ (MP3)', 'yt-playlist-audio-btn');
                audioBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    e.stopImmediatePropagation();
                    downloadMedia(videoUrl, 'audio');
                }, true);

                const videoBtn = createDownloadButton('yt-playlist-btn', 'ðŸŽ¬', 'ä¸‹è½½è§†é¢‘');
                videoBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    e.stopImmediatePropagation();
                    showQualityMenu(videoUrl);
                }, true);

                btnContainer.appendChild(audioBtn);
                btnContainer.appendChild(videoBtn);

                thumbnailContainer.style.position = 'relative';
                thumbnailContainer.appendChild(btnContainer);
            } catch (error) {
                console.error(`âŒ å¤„ç†æ’­æ”¾åˆ—è¡¨è§†é¢‘ ${index} æ—¶å‡ºé”™:`, error);
            }
        });
    }

    // ä¸ºè§†é¢‘æ’­æ”¾é¡µæ·»åŠ ä¸‹è½½æŒ‰é’®
    function addButtonsToVideoPlayer() {
        if (document.getElementById('yt-player-download-buttons')) return;

        const videoPlayer = document.querySelector('#movie_player') ||
                           document.querySelector('ytd-player') ||
                           document.querySelector('.html5-video-player') ||
                           document.querySelector('#player-container');

        if (!videoPlayer) return;

        const videoUrl = extractSingleVideoUrl();
        if (!videoUrl) return;

        const buttonContainer = document.createElement('div');
        buttonContainer.id = 'yt-player-download-buttons';
        buttonContainer.className = 'yt-player-buttons';

        const audioBtn = document.createElement('button');
        audioBtn.className = 'yt-player-btn yt-player-audio-btn';
        audioBtn.textContent = 'ðŸŽµ éŸ³é¢‘';
        audioBtn.type = 'button';
        audioBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            downloadMedia(videoUrl, 'audio');
        }, true);

        const videoBtn = document.createElement('button');
        videoBtn.className = 'yt-player-btn';
        videoBtn.textContent = 'ðŸŽ¬ è§†é¢‘';
        videoBtn.type = 'button';
        videoBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            showQualityMenu(videoUrl);
        }, true);

        buttonContainer.appendChild(audioBtn);
        buttonContainer.appendChild(videoBtn);

        videoPlayer.style.position = 'relative';
        videoPlayer.appendChild(buttonContainer);

        console.log('âœ… å·²ä¸ºè§†é¢‘æ’­æ”¾å™¨æ·»åŠ ä¸‹è½½æŒ‰é’®');
    }

    // ä¸‹è½½åª’ä½“å‡½æ•°
    function downloadMedia(url, type, quality) {
        const cleanUrl = new URL(url);
        cleanUrl.searchParams.delete('list');
        cleanUrl.searchParams.delete('index');
        const finalUrl = cleanUrl.toString();

        console.log('ðŸš€ å•ä¸ªè§†é¢‘ä¸‹è½½è¯·æ±‚:', {url: finalUrl, type, quality});
        showNotification('æ­£åœ¨å¯åŠ¨ä¸‹è½½ä»»åŠ¡...', 'info');

        GM_xmlhttpRequest({
            method: 'POST',
            url: `${API_BASE}/download`,
            headers: {
                'Content-Type': 'application/json',
            },
            data: JSON.stringify({
                url: finalUrl,
                type: type,
                quality: quality || 'best'
            }),
            onload: function(response) {
                try {
                    const result = JSON.parse(response.responseText);
                    if (result.success) {
                        showNotification('ä¸‹è½½ä»»åŠ¡å·²å¯åŠ¨ï¼ä¿å­˜è·¯å¾„ï¼š' + result.download_path, 'success');
                    } else {
                        showNotification('ä¸‹è½½å¤±è´¥: ' + result.error, 'error');
                    }
                } catch (e) {
                    showNotification('è§£æžå“åº”å¤±è´¥: ' + e.message, 'error');
                }
            },
            onerror: function() {
                showNotification('è¿žæŽ¥æœåŠ¡å™¨å¤±è´¥ï¼Œè¯·ç¡®ä¿æœ¬åœ°æœåŠ¡æ­£åœ¨è¿è¡Œ (http://localhost:8899)', 'error');
            }
        });
    }

    // ä¸‹è½½æ’­æ”¾åˆ—è¡¨å‡½æ•°
    function downloadPlaylist(playlistUrl, type, quality) {
        console.log('ðŸš€ æ’­æ”¾åˆ—è¡¨æ‰¹é‡ä¸‹è½½è¯·æ±‚:', {playlistUrl, type, quality});
        showNotification('æ­£åœ¨å¯åŠ¨æ’­æ”¾åˆ—è¡¨æ‰¹é‡ä¸‹è½½ä»»åŠ¡...', 'info');

        GM_xmlhttpRequest({
            method: 'POST',
            url: `${API_BASE}/download-playlist`,
            headers: {
                'Content-Type': 'application/json',
            },
            data: JSON.stringify({
                playlist_url: playlistUrl,
                type: type,
                quality: quality || 'best'
            }),
            onload: function(response) {
                try {
                    const result = JSON.parse(response.responseText);
                    if (result.success) {
                        showNotification('æ’­æ”¾åˆ—è¡¨æ‰¹é‡ä¸‹è½½ä»»åŠ¡å·²å¯åŠ¨ï¼ä¿å­˜è·¯å¾„ï¼š' + result.download_path, 'success');
                    } else {
                        showNotification('æ’­æ”¾åˆ—è¡¨ä¸‹è½½å¤±è´¥: ' + result.error, 'error');
                    }
                } catch (e) {
                    showNotification('è§£æžå“åº”å¤±è´¥: ' + e.message, 'error');
                }
            },
            onerror: function() {
                showNotification('è¿žæŽ¥æœåŠ¡å™¨å¤±è´¥ï¼Œè¯·ç¡®ä¿æœ¬åœ°æœåŠ¡æ­£åœ¨è¿è¡Œ (http://localhost:8899)', 'error');
            }
        });
    }

    // æ˜¾ç¤ºè´¨é‡é€‰æ‹©èœå•
    function showQualityMenu(url) {
        const existingMenu = document.getElementById('yt-quality-menu');
        const existingOverlay = document.getElementById('yt-quality-overlay');
        if (existingMenu) existingMenu.remove();
        if (existingOverlay) existingOverlay.remove();

        const overlay = document.createElement('div');
        overlay.id = 'yt-quality-overlay';
        overlay.style.cssText = `
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 100% !important;
            height: 100% !important;
            background: rgba(0, 0, 0, 0.5) !important;
            z-index: 9999998 !important;
        `;

        const menu = document.createElement('div');
        menu.id = 'yt-quality-menu';
        menu.style.cssText = `
            position: fixed !important;
            top: 50% !important;
            left: 50% !important;
            transform: translate(-50%, -50%) !important;
            background: white !important;
            border: 2px solid #ccc !important;
            border-radius: 12px !important;
            padding: 24px !important;
            z-index: 9999999 !important;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3) !important;
            min-width: 250px !important;
            max-width: 90vw !important;
        `;

        const title = document.createElement('h3');
        title.textContent = 'é€‰æ‹©è§†é¢‘è´¨é‡';
        title.style.cssText = `
            margin: 0 0 20px 0 !important;
            color: #333 !important;
            text-align: center !important;
            font-size: 18px !important;
        `;
        menu.appendChild(title);

        const qualities = [
            { key: '4k', label: '4K (2160p)', desc: 'è¶…é«˜æ¸…' },
            { key: 'best', label: 'æœ€é«˜ç”»è´¨ (1080p)', desc: 'æŽ¨è' },
            { key: '720p', label: 'é«˜æ¸… (720p)', desc: 'å¹³è¡¡' },
            { key: '480p', label: 'æ ‡æ¸… (480p)', desc: 'èŠ‚çœç©ºé—´' },
            { key: 'small', label: 'æœ€å°æ–‡ä»¶', desc: 'æœ€å°ä½“ç§¯' }
        ];

        qualities.forEach((quality, index) => {
            const btn = document.createElement('button');
            btn.type = 'button';

            const labelDiv = document.createElement('div');
            labelDiv.style.textAlign = 'left';

            const titleDiv = document.createElement('div');
            titleDiv.style.fontWeight = 'bold';
            titleDiv.textContent = quality.label;

            const descDiv = document.createElement('div');
            descDiv.style.fontSize = '11px';
            descDiv.style.opacity = '0.8';
            descDiv.textContent = quality.desc;

            labelDiv.appendChild(titleDiv);
            labelDiv.appendChild(descDiv);
            btn.appendChild(labelDiv);

            btn.style.cssText = `
                display: block !important;
                width: 100% !important;
                margin: 8px 0 !important;
                padding: 12px 16px !important;
                background: ${index === 1 ? '#ff0000' : '#666'} !important;
                color: white !important;
                border: none !important;
                border-radius: 8px !important;
                cursor: pointer !important;
                text-align: left !important;
            `;

            btn.addEventListener('click', function() {
                downloadMedia(url, 'video', quality.key);
                if (overlay.parentNode) document.body.removeChild(overlay);
                if (menu.parentNode) document.body.removeChild(menu);
            });

            menu.appendChild(btn);
        });

        const cancelBtn = document.createElement('button');
        cancelBtn.textContent = 'å–æ¶ˆ';
        cancelBtn.type = 'button';
        cancelBtn.style.cssText = `
            display: block !important;
            width: 100% !important;
            margin: 16px 0 0 0 !important;
            padding: 12px !important;
            background: #999 !important;
            color: white !important;
            border: none !important;
            border-radius: 8px !important;
            cursor: pointer !important;
        `;

        const closeMenu = () => {
            if (overlay.parentNode) document.body.removeChild(overlay);
            if (menu.parentNode) document.body.removeChild(menu);
        };

        cancelBtn.addEventListener('click', closeMenu);
        overlay.addEventListener('click', closeMenu);

        menu.appendChild(cancelBtn);

        document.body.appendChild(overlay);
        document.body.appendChild(menu);
    }

    // æ˜¾ç¤ºæ’­æ”¾åˆ—è¡¨è´¨é‡é€‰æ‹©èœå•
    function showPlaylistQualityMenu(playlistUrl) {
        const existingMenu = document.getElementById('yt-playlist-quality-menu');
        const existingOverlay = document.getElementById('yt-playlist-quality-overlay');
        if (existingMenu) existingMenu.remove();
        if (existingOverlay) existingOverlay.remove();

        const overlay = document.createElement('div');
        overlay.id = 'yt-playlist-quality-overlay';
        overlay.style.cssText = `
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 100% !important;
            height: 100% !important;
            background: rgba(0, 0, 0, 0.5) !important;
            z-index: 9999998 !important;
        `;

        const menu = document.createElement('div');
        menu.id = 'yt-playlist-quality-menu';
        menu.style.cssText = `
            position: fixed !important;
            top: 50% !important;
            left: 50% !important;
            transform: translate(-50%, -50%) !important;
            background: white !important;
            border: 2px solid #ccc !important;
            border-radius: 12px !important;
            padding: 24px !important;
            z-index: 9999999 !important;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3) !important;
            min-width: 280px !important;
            max-width: 90vw !important;
        `;

        const title = document.createElement('h3');
        title.textContent = 'é€‰æ‹©æ’­æ”¾åˆ—è¡¨è§†é¢‘è´¨é‡';
        title.style.cssText = `
            margin: 0 0 20px 0 !important;
            color: #333 !important;
            text-align: center !important;
            font-size: 18px !important;
        `;
        menu.appendChild(title);

        const qualities = [
            { key: '4k', label: '4K (2160p)', desc: 'è¶…é«˜æ¸… - æ–‡ä»¶è¾ƒå¤§' },
            { key: 'best', label: 'æœ€é«˜ç”»è´¨ (1080p)', desc: 'æŽ¨è - è´¨é‡ä¸Žå¤§å°å¹³è¡¡' },
            { key: '720p', label: 'é«˜æ¸… (720p)', desc: 'å¹³è¡¡ - é€‚ä¸­å¤§å°' },
            { key: '480p', label: 'æ ‡æ¸… (480p)', desc: 'èŠ‚çœç©ºé—´' },
            { key: 'small', label: 'æœ€å°æ–‡ä»¶', desc: 'æœ€å°ä½“ç§¯ - å¿«é€Ÿä¸‹è½½' }
        ];

        qualities.forEach((quality, index) => {
            const btn = document.createElement('button');
            btn.type = 'button';

            const labelDiv = document.createElement('div');
            labelDiv.style.textAlign = 'left';

            const titleDiv = document.createElement('div');
            titleDiv.style.fontWeight = 'bold';
            titleDiv.textContent = quality.label;

            const descDiv = document.createElement('div');
            descDiv.style.fontSize = '11px';
            descDiv.style.opacity = '0.8';
            descDiv.textContent = quality.desc;

            labelDiv.appendChild(titleDiv);
            labelDiv.appendChild(descDiv);
            btn.appendChild(labelDiv);

            btn.style.cssText = `
                display: block !important;
                width: 100% !important;
                margin: 8px 0 !important;
                padding: 12px 16px !important;
                background: ${index === 1 ? '#ff0000' : '#666'} !important;
                color: white !important;
                border: none !important;
                border-radius: 8px !important;
                cursor: pointer !important;
                text-align: left !important;
            `;

            btn.addEventListener('click', function() {
                downloadPlaylist(playlistUrl, 'video', quality.key);
                if (overlay.parentNode) document.body.removeChild(overlay);
                if (menu.parentNode) document.body.removeChild(menu);
            });

            menu.appendChild(btn);
        });

        const cancelBtn = document.createElement('button');
        cancelBtn.textContent = 'å–æ¶ˆ';
        cancelBtn.type = 'button';
        cancelBtn.style.cssText = `
            display: block !important;
            width: 100% !important;
            margin: 16px 0 0 0 !important;
            padding: 12px !important;
            background: #999 !important;
            color: white !important;
            border: none !important;
            border-radius: 8px !important;
            cursor: pointer !important;
        `;

        const closeMenu = () => {
            if (overlay.parentNode) document.body.removeChild(overlay);
            if (menu.parentNode) document.body.removeChild(menu);
        };

        cancelBtn.addEventListener('click', closeMenu);
        overlay.addEventListener('click', closeMenu);

        menu.appendChild(cancelBtn);

        document.body.appendChild(overlay);
        document.body.appendChild(menu);
    }

    // æ˜¾ç¤ºé€šçŸ¥
    function showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.style.cssText = `
            position: fixed !important;
            top: 20px !important;
            right: 20px !important;
            padding: 12px 20px !important;
            background: ${type === 'success' ? '#4CAF50' : type === 'error' ? '#f44336' : '#2196F3'} !important;
            color: white !important;
            border-radius: 6px !important;
            z-index: 9999999 !important;
            max-width: 400px !important;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3) !important;
            font-size: 14px !important;
        `;
        notification.textContent = message;

        document.body.appendChild(notification);

        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 5000);
    }

    // æ¸…ç†æ—§æŒ‰é’®
    function cleanupOldButtons() {
        const elementsToRemove = [
            '#yt-player-download-buttons',
            '#yt-shorts-player-download-buttons'
        ];

        elementsToRemove.forEach(selector => {
            const element = document.querySelector(selector);
            if (element) element.remove();
        });

        document.querySelectorAll('[data-download-added]').forEach(card => {
            card.removeAttribute('data-download-added');
        });

        document.querySelectorAll('[data-recommendation-download-added]').forEach(card => {
            card.removeAttribute('data-recommendation-download-added');
        });

        document.querySelectorAll('[data-shorts-download-added]').forEach(card => {
            card.removeAttribute('data-shorts-download-added');
        });

        document.querySelectorAll('[data-batch-download-added]').forEach(panel => {
            panel.removeAttribute('data-batch-download-added');
        });

        document.querySelectorAll('.yt-playlist-batch-btns, .yt-download-btns, .yt-shorts-btns, .yt-recommendation-btns, .yt-playlist-btns').forEach(btn => {
            btn.remove();
        });
    }

    // é˜²æŠ–å‡½æ•°
    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }

    // æ·»åŠ æ‰€æœ‰ç±»åž‹çš„æŒ‰é’®
    function addAllButtons() {
        addButtonsToVideoCards();
        addButtonsToShorts();
        addButtonsToPlaylistVideos();
        addButtonsToRecommendations();
        addPlaylistBatchButtons();
    }

    // å®šæœŸå¼ºåˆ¶æ£€æŸ¥å¹¶æ·»åŠ æ‰¹é‡ä¸‹è½½æŒ‰é’®
    function periodicCheckForPlaylist() {
        if (isPlaylistPage()) {
            const existingBtns = document.querySelectorAll('.yt-playlist-batch-btns');
            if (existingBtns.length === 0) {
                console.log('ðŸ”„ å®šæœŸæ£€æŸ¥ï¼šå‘çŽ°æ’­æ”¾åˆ—è¡¨é¡µé¢ä½†æ— æ‰¹é‡æŒ‰é’®ï¼Œæ·»åŠ ä¸­...');
                addPlaylistBatchButtons();
            }
        }
    }

    // åˆå§‹åŒ–
    function init() {
        console.log('ðŸš€ YouTubeä¸‹è½½åŠ©æ‰‹åˆå§‹åŒ–, å½“å‰URL:', window.location.href);
        injectStyles();

        setTimeout(() => {
            addAllButtons();
            if (window.location.pathname.includes('/watch')) {
                addButtonsToVideoPlayer();
            } else if (window.location.pathname.includes('/shorts/')) {
                addButtonsToShortsPlayer();
            }
        }, 1000);
    }

    // é˜²æŠ–çš„æ·»åŠ æŒ‰é’®å‡½æ•°
    const debouncedAddButtons = debounce(() => {
        addAllButtons();
        if (window.location.pathname.includes('/shorts/')) {
            addButtonsToShortsPlayer();
        }
    }, 300);

    // é¡µé¢å˜åŒ–ç›‘å¬
    let lastUrl = location.href;
    const observer = new MutationObserver(() => {
        const url = location.href;
        if (url !== lastUrl) {
            console.log('ðŸ”„ é¡µé¢å¯¼èˆª:', lastUrl, '->', url);
            lastUrl = url;
            cleanupOldButtons();
            setTimeout(init, 1000);
        } else {
            debouncedAddButtons();
        }
    });

    observer.observe(document.body, {
        childList: true,
        subtree: true
    });

    // YouTubeå¯¼èˆªäº‹ä»¶
    window.addEventListener('yt-navigate-finish', () => {
        console.log('ðŸŽ¬ YouTubeå¯¼èˆªå®Œæˆ');
        cleanupOldButtons();
        setTimeout(init, 800);
    });

    // åˆå§‹åŒ–
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
    } else {
        setTimeout(init, 500);
    }

    // å®šæœŸæ£€æŸ¥æ’­æ”¾åˆ—è¡¨æ‰¹é‡ä¸‹è½½æŒ‰é’®
    setInterval(periodicCheckForPlaylist, 3000);

    // å®šæœŸæ£€æŸ¥å…¶ä»–æŒ‰é’®
    setInterval(() => {
        debouncedAddButtons();
    }, 8000);

    console.log('ðŸŽ‰ YouTubeè§†é¢‘ä¸‹è½½åŠ©æ‰‹ (æ’­æ”¾åˆ—è¡¨æ‰¹é‡ä¸‹è½½ç‰ˆ) å·²åŠ è½½');
})();
